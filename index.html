<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Master Finance</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  background: linear-gradient(180deg, #820ad1, #4c0099);
  color: white;
  padding: 20px;
}

h1 {
  text-align: center;
}

.card {
  background: white;
  color: black;
  padding: 20px;
  border-radius: 20px;
  margin-bottom: 20px;
  box-shadow: 0 15px 35px rgba(0,0,0,0.2);
}

.resumo {
  display: flex;
  justify-content: space-between;
  font-weight: bold;
  font-size: 18px;
}

.receita { color: #00c853; }
.despesa { color: #d50000; }

button {
  background: #820ad1;
  color: white;
  border: none;
  padding: 6px 10px;
  border-radius: 8px;
  cursor: pointer;
}

select {
  padding: 5px;
  border-radius: 6px;
}
</style>
</head>
<body>

<h1>üí∞ Master Finance</h1>

<div class="card resumo">
  <div>Receitas: <span id="receitas" class="receita">R$ 0</span></div>
  <div>Despesas: <span id="despesas" class="despesa">R$ 0</span></div>
  <div>Saldo: <span id="saldo">R$ 0</span></div>
</div>

<div class="card">
  <label>Filtrar por m√™s:</label>
  <input type="month" id="filtroMes">
</div>

<div class="card">
  <canvas id="grafico"></canvas>
</div>

<div class="card">
  <h3>Transa√ß√µes</h3>
  <ul id="lista"></ul>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, onSnapshot, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAPEv9rP_Ek60NrGfMJnEO3dPzFM4j36cI",
  authDomain: "master-finance-bce36.firebaseapp.com",
  projectId: "master-finance-bce36",
  storageBucket: "master-finance-bce36.firebasestorage.app",
  messagingSenderId: "241893077182",
  appId: "1:241893077182:web:b8100d0ca968ba90a42eef"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let chart;

onAuthStateChanged(auth, user => {
  if (!user) {
    alert("Usu√°rio n√£o logado");
    return;
  }

  const transacoesRef = collection(db, "users", user.uid, "transacoes");

  onSnapshot(transacoesRef, snapshot => {
    let receitas = 0;
    let despesas = 0;
    let categorias = {};
    const lista = document.getElementById("lista");
    lista.innerHTML = "";

    const filtroMes = document.getElementById("filtroMes").value;

    snapshot.forEach(docSnap => {
      const data = docSnap.data();

      if (!data.data) return;

      const dataTransacao = data.data.toDate();
      const mesTransacao = dataTransacao.toISOString().slice(0,7);

      if (filtroMes && mesTransacao !== filtroMes) return;

      const valor = Number(data.valor);
      const tipo = data.tipo.toLowerCase();

      if (tipo === "receita") {
        receitas += valor;
      } else {
        despesas += valor;
        categorias[data.categoria] = (categorias[data.categoria] || 0) + valor;
      }

      const li = document.createElement("li");
      li.innerHTML = `
        ${data.descricao} - R$ ${valor}
        <button onclick="editar('${docSnap.id}','${data.descricao}',${valor},'${data.tipo}')">‚úè</button>
        <button onclick="excluir('${docSnap.id}')">üóë</button>
      `;
      lista.appendChild(li);
    });

    document.getElementById("receitas").innerText = "R$ " + receitas.toFixed(2);
    document.getElementById("despesas").innerText = "R$ " + despesas.toFixed(2);
    document.getElementById("saldo").innerText = "R$ " + (receitas - despesas).toFixed(2);

    atualizarGrafico(categorias);
  });
});

document.getElementById("filtroMes").addEventListener("change", () => {
  location.reload();
});

window.excluir = async function(id) {
  const user = auth.currentUser;
  await deleteDoc(doc(db, "users", user.uid, "transacoes", id));
};

window.editar = async function(id, descricao, valor, tipo) {
  const novaDescricao = prompt("Descri√ß√£o:", descricao);
  const novoValor = prompt("Valor:", valor);
  const novoTipo = prompt("Tipo (receita/despesa):", tipo);

  const user = auth.currentUser;

  await updateDoc(doc(db, "users", user.uid, "transacoes", id), {
    descricao: novaDescricao,
    valor: Number(novoValor),
    tipo: novoTipo.toLowerCase()
  });
};

function atualizarGrafico(categorias) {
  const ctx = document.getElementById('grafico');

  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: Object.keys(categorias),
      datasets: [{
        data: Object.values(categorias)
      }]
    }
  });
}

</script>
</body>
</html>